import{c as _}from"./chunk-IBBFEWMW.js";import{e as n}from"./chunk-JHI3MBHO.js";var I=class extends _{constructor(){super(...arguments),this.model=null,this.isInitializing=!1,this.scriptsLoaded=!1}initialize(){return n(this,null,function*(){if(this.model)return{success:!0};if(this.isInitializing)return yield this.waitForModel(),{success:this.model!==null};this.isInitializing=!0;try{return yield this.loadScripts(),console.log("Loading BlazeFace model..."),this.model=yield blazeface.load(),console.log("BlazeFace model loaded successfully"),this.isInitializing=!1,{success:!0}}catch(t){return console.error("Failed to initialize face detection:",t),this.isInitializing=!1,{success:!1}}})}loadScripts(){return n(this,null,function*(){if(!this.scriptsLoaded){if(typeof tf<"u"&&typeof blazeface<"u"){this.scriptsLoaded=!0;return}yield this.loadScript("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"),yield new Promise(t=>setTimeout(t,500)),yield this.loadScript("https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.js"),yield new Promise(t=>setTimeout(t,300)),this.scriptsLoaded=!0}})}loadScript(t){return new Promise((e,s)=>{if(document.querySelector(`script[src="${t}"]`)){e();return}let i=document.createElement("script");i.src=t,i.async=!0,i.onload=()=>e(),i.onerror=()=>s(new Error(`Failed to load script: ${t}`)),document.head.appendChild(i)})}waitForModel(){return n(this,null,function*(){let s=0;for(;this.isInitializing&&s<3e4;)yield new Promise(i=>setTimeout(i,100)),s+=100})}detectFace(t){return n(this,null,function*(){if(!this.model&&!(yield this.initialize()).success)return{faceDetected:!1,guidance:"no_face"};try{let e=yield this.loadImage(t.imageData),s=yield this.model.estimateFaces(e,!1);if(!s||s.length===0)return{faceDetected:!1,guidance:"no_face"};if(s.length>1)return{faceDetected:!0,guidance:"multiple_faces"};let i=s[0],o={x:i.topLeft[0]/e.width,y:i.topLeft[1]/e.height,width:(i.bottomRight[0]-i.topLeft[0])/e.width,height:(i.bottomRight[1]-i.topLeft[1])/e.height},l=t.sensitivity??.5,a=this.calculateGuidance(o,t.ovalBounds,l);return{faceDetected:!0,bounds:o,guidance:a,confidence:i.probability?.[0]??.9}}catch(e){return console.error("Face detection error:",e),{faceDetected:!1,guidance:"no_face"}}})}loadImage(t){return new Promise((e,s)=>{let i=new Image;i.onload=()=>e(i),i.onerror=s,i.src=t})}calculateGuidance(t,e,s){let i=(r,g)=>r+(g-r)*s,o=t.height*.4,l=t.height*.08,a=t.width*.1,d=t.x-a,u=t.x+t.width+a,h=t.y-o,f=t.y+t.height+l,p=(d+u)/2,w=(h+f)/2,x=e.centerX-e.radiusX,L=e.centerX+e.radiusX,S=e.centerY-e.radiusY,P=e.centerY+e.radiusY,R=u-d,F=f-h,T=Math.max(R,F),X=Math.max(e.radiusX*2,e.radiusY*2),v=T/X,Y=i(.85,.6),B=i(1.1,1.4);if(v<Y)return"move_closer";if(v>B)return"move_back";let c=i(0,.08),M=x-d-c,O=u-L-c,j=S-h-c,D=f-P-c,m=[{value:M,guidance:"move_right"},{value:O,guidance:"move_left"},{value:j,guidance:"move_down"},{value:D,guidance:"move_up"}];if(m.sort((r,g)=>g.value-r.value),m[0].value>0)return m[0].guidance;let y=i(.08,.25),z=Math.abs(p-e.centerX),b=Math.abs(w-e.centerY);return z>y||b>y?b>z?w<e.centerY?"move_down":"move_up":p<e.centerX?"move_right":"move_left":"hold_still"}isAvailable(){return n(this,null,function*(){return{available:!0,platform:"web"}})}dispose(){return n(this,null,function*(){this.model&&(this.model=null)})}};export{I as FaceDetectionWeb};
