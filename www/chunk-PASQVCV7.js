import{d as w}from"./chunk-FEDQF4VK.js";import{e as n}from"./chunk-JHI3MBHO.js";var v=class extends w{constructor(){super(...arguments),this.model=null,this.isInitializing=!1,this.scriptsLoaded=!1}initialize(){return n(this,null,function*(){if(this.model)return{success:!0};if(this.isInitializing)return yield this.waitForModel(),{success:this.model!==null};this.isInitializing=!0;try{return yield this.loadScripts(),console.log("Loading BlazeFace model..."),this.model=yield blazeface.load(),console.log("BlazeFace model loaded successfully"),this.isInitializing=!1,{success:!0}}catch(t){return console.error("Failed to initialize face detection:",t),this.isInitializing=!1,{success:!1}}})}loadScripts(){return n(this,null,function*(){if(!this.scriptsLoaded){if(typeof tf<"u"&&typeof blazeface<"u"){this.scriptsLoaded=!0;return}yield this.loadScript("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"),yield new Promise(t=>setTimeout(t,500)),yield this.loadScript("https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.js"),yield new Promise(t=>setTimeout(t,300)),this.scriptsLoaded=!0}})}loadScript(t){return new Promise((e,s)=>{if(document.querySelector(`script[src="${t}"]`)){e();return}let i=document.createElement("script");i.src=t,i.async=!0,i.onload=()=>e(),i.onerror=()=>s(new Error(`Failed to load script: ${t}`)),document.head.appendChild(i)})}waitForModel(){return n(this,null,function*(){let s=0;for(;this.isInitializing&&s<3e4;)yield new Promise(i=>setTimeout(i,100)),s+=100})}detectFace(t){return n(this,null,function*(){if(!this.model&&!(yield this.initialize()).success)return{faceDetected:!1,guidance:"no_face"};try{let e=yield this.loadImage(t.imageData),s=yield this.model.estimateFaces(e,!1);if(!s||s.length===0)return{faceDetected:!1,guidance:"no_face"};if(s.length>1)return{faceDetected:!0,guidance:"multiple_faces"};let i=s[0],a={x:i.topLeft[0]/e.width,y:i.topLeft[1]/e.height,width:(i.bottomRight[0]-i.topLeft[0])/e.width,height:(i.bottomRight[1]-i.topLeft[1])/e.height},o=this.calculateGuidance(a,t.ovalBounds);return{faceDetected:!0,bounds:a,guidance:o,confidence:i.probability?.[0]??.9}}catch(e){return console.error("Face detection error:",e),{faceDetected:!1,guidance:"no_face"}}})}loadImage(t){return new Promise((e,s)=>{let i=new Image;i.onload=()=>e(i),i.onerror=s,i.src=t})}calculateGuidance(t,e){let s=t.height*.4,i=t.height*.08,a=t.width*.1,o=t.x-a,c=t.x+t.width+a,r=t.y-s,d=t.y+t.height+i,u=(o+c)/2,h=(r+d)/2,y=e.centerX-e.radiusX,z=e.centerX+e.radiusX,b=e.centerY-e.radiusY,_=e.centerY+e.radiusY,I=c-o,L=d-r,x=Math.max(I,L),P=Math.max(e.radiusX*2,e.radiusY*2),f=x/P;if(f<.8)return"move_closer";if(f>1.15)return"move_back";let S=y-o,F=c-z,X=b-r,Y=d-_,l=[{value:S,guidance:"move_right"},{value:F,guidance:"move_left"},{value:X,guidance:"move_down"},{value:Y,guidance:"move_up"}];if(l.sort((R,T)=>T.value-R.value),l[0].value>0)return l[0].guidance;let m=.15,g=Math.abs(u-e.centerX),p=Math.abs(h-e.centerY);return g>m||p>m?p>g?h<e.centerY?"move_down":"move_up":u<e.centerX?"move_right":"move_left":"hold_still"}isAvailable(){return n(this,null,function*(){return{available:!0,platform:"web"}})}dispose(){return n(this,null,function*(){this.model&&(this.model=null)})}};export{v as FaceDetectionWeb};
